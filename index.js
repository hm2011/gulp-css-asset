function getUrlFormPath(e,t){return url.resolve(t.staticPath,path.relative(path.resolve(t.cwd,t.base),e).replace(/\\/g,"/"))}function collectInfo(e,t,r,s){let n=e.contents.toString().replace(/\burl\(\s*(['"]?)\s*(([\:\.\w\/\-]+)(\?[\w%&\=\-]*)?(#[\w]*)?)\s*\1\s*\)/gi,function(t,n,i,a,o,u,p,c){let l,h,f=o||"",g=u||"";return/^data\:/.test(url)?(msg.info("跳过base64编码资源: "+i),'url("'+i+'")'):/^(https?\:)?\/\//.test(i)?(msg.info("跳过网络资源: "+i),'url("'+i+'")'):(/^\//.test(i)?(l=path.resolve(s.cwd,s.rootPath,a.replace(/^\//,"")),h=url.resolve(s.staticPath,a.replace(/^\//,""))):h=getUrlFormPath(l=path.resolve(e.dirname,a),s),fs.existsSync(l)?(/\.css$/i.test(l)?msg.warn("跳过导入的css资源: "+l):r.includes(l)||r.push(l),'url("'+h+f+g+'")'):(msg.err("引用资源不存在: "+i+" (引用位置："+e.path+")"),'url("'+i+'")'))});e.contents=new Buffer(n),t.push(e)}function createBuildInfo(e,t){let r=[];return e.forEach(function(e,s){if("function"==typeof t.base64?!t.base64(e):!t.base64)if([".png",".jpg",".gif"].includes(path.extname(e).toLowerCase())){let s="";if("function"==typeof t.sprite?s=t.sprite(e):"string"==typeof t.sprite&&(s=t.sprite),""!==s){let n=path.resolve(t.cwd,t.base,s),i=url.resolve(t.staticPath,s),a=!1;r.forEach(function(t,r){t.path===n&&(t.images.push(e),a=!0)}),a||r.push({type:"sprite",path:n,url:i,images:[e]})}else r.push({type:"none",path:e})}else r.push({type:"none",path:e});else r.push({type:"base64",path:e})}),r}function build(e,t){let r=[],s=[],n=[];return e.forEach(function(e,i){if("base64"===e.type){let n=mime.lookup(e.path),i=function(r,i){fs.createReadStream(e.path).pipe(bl(function(a,o){if(a)return msg.err("base64编码错误: "+e.path),void i(a);s.push({type:"base64",target:getUrlFormPath(e.path,t),base64:"data:"+(n?n+";":"")+"base64,"+o.toString("base64")}),r()}))};r.push(new Promise(i))}else if("sprite"===e.type){let i=new Spritesmith,a=function(r,a){i.createImages(e.images,function(o,u){if(o)return msg.err("图片合并发生错误: "+e.path),void a(o);let p=i.processImages(u,{padding:0,algorithm:"binary-tree"});p.image.pipe(bl(function(i,o){if(i)return msg.err("合并图片读取错误: "+e.path),void a(i);let u=new File({cwd:t.cwd,base:t.base,path:e.path,contents:o});n.push(u);let c=getUrlFormPath(e.path,t);e.images.forEach(function(e,r){s.push({type:"sprite",target:getUrlFormPath(e,t),sprite:c,x:p.coordinates[e].x,y:p.coordinates[e].y,width:p.coordinates[e].width,height:p.coordinates[e].height})}),r()}))})};r.push(new Promise(a))}else{let s=function(r,s){fs.createReadStream(e.path).pipe(bl(function(i,a){if(i)return msg.err("文件处理错误: "+e.path),void s(i);let o=new File({cwd:t.cwd,base:t.base,path:e.path,contents:a});n.push(o),r()}))};r.push(new Promise(s))}}),Promise.all(r).then(function(){return{updateInfos:s,assetFiles:n}})}function updateCss(e,t,r){let s=function(){let e=0===r.tabSize?"\t":"";for(let t=0;t<r.tabSize;t++)e+=" ";return e}();return e.forEach(function(e,r){var n=e.contents.toString();t.forEach(function(e){var t;"sprite"===e.type?(t=new RegExp('(background(\\-image)?\\s*\\:.*?url\\(")'+e.target.replace(/[|\\/{}()\[\]^$+*?.]/g,"\\$&")+'((\\?[\\w%&\\=\\-]*)?(#[\\w]*)?"\\).*?;)',"ig"),n=n.replace(t,function(t,r,n,i,a,o,u,p){return r+e.sprite+i+"\n"+s+"background-position: -"+e.x+"px -"+e.y+"px;"})):"base64"===e.type&&(t=new RegExp('\\burl\\("'+e.target.replace(/[|\\/{}()\[\]^$+*?.]/g,"\\$&")+'(\\?[\\w%&\\=\\-]*)?(#[\\w]*)?"\\)',"ig"),n=n.replace(t,function(t,r,s,n,i){return'url("'+e.base64+'")'}))}),e.contents=new Buffer(n)}),e}const path=require("path"),fs=require("fs"),url=require("url"),File=require("vinyl"),through=require("through2"),Spritesmith=require("spritesmith"),colors=require("colors"),gutil=require("gulp-util"),bl=require("bl"),mime=require("mime"),PLUGIN_NAME="gulp-css-asset",msg=function(){let e={info:"["+colors.green("info")+"]",error:"["+colors.red("error")+"]",warn:"["+colors.yellow("warning")+"]"},t=function(t,r){t.unshift(e[r]),t.unshift("["+colors.green(PLUGIN_NAME)+"]"),gutil.log.apply(gutil,t)};return{info:function(){t(Array.prototype.slice.call(arguments),"info")},err:function(){t(Array.prototype.slice.call(arguments),"error")},warn:function(){t(Array.prototype.slice.call(arguments),"warn")}}}();module.exports=function(e){"use strict";let t=Object.assign({},{sprite:"",base64:!1,staticPath:"/",tabSize:0},e),r=[],s=[];return through.obj(function(e,n,i){return t.cwd=t.cwd||e.cwd,t.base=t.base||e.base,t.rootPath=t.rootPath||e.base,e.isNull()?(msg.warn("空文件跳过处理:"+e.path),this.push(e),i()):".css"!==e.extname.toLowerCase()?(msg.warn("非CSS文件跳过处理:"+e.path),this.push(e),i()):e.isStream()?(msg.warn("stream类型文件跳过处理:"+e.path),this.push(e),i()):(collectInfo(e,r,s,t),void i())},function(e){let n=this;build(createBuildInfo(s,t),t).then(function(e){return e.assetFiles.forEach(function(e){n.push(e)}),updateCss(r,e.updateInfos,t)}).then(function(e){e.forEach(function(e){n.push(e)})}).then(function(){e()}).catch(function(t){e(t)})})};